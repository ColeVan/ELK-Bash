# ELK-Bash: Automated ELK Stack Deployment

![image](https://github.com/user-attachments/assets/8e753cf4-0682-44fa-8958-af8013fad562)

ELK-Bash is a collection of Bash scripts designed to automate the installation and configuration of the Elastic Stack (Elasticsearch, Logstash, Kibana) along with Elastic Agent and Fleet Server on Ubuntu systems.

## Overview

These scripts streamline the process of setting up a single-node ELK deployment or the initial node of an ELK cluster. They handle package installation, service configuration, SSL certificate generation, and basic security setup.

## Features

*   Interactive prompts for guided setup via `orchestrate.sh`.
*   Automated cleanup of previous ELK installations.
*   Installation of Elasticsearch, Logstash, and Kibana.
*   SSL/TLS configuration for secure communication.
*   Elastic Agent and Fleet Server setup.
*   Creation of default Fleet policies (including Windows EDR).
*   Logstash output configuration for Fleet.
*   Generation of enrollment tokens for Elasticsearch cluster expansion.
*   Support for both internet-connected and air-gapped environments (for package downloads).
*   LVM root volume extension capability on Ubuntu.

## Prerequisites

*   **Operating System:** Ubuntu-based Linux distribution.
*   **Permissions:** `sudo` access is required to run the scripts.
*   **System Resources:**
    *   **CPU:** Minimum 4 vCPUs recommended.
    *   **RAM:** Minimum 8GB RAM (Logstash JVM heap is configured for 8GB). More may be needed for production loads.
    *   **Disk:** Sufficient disk space for ELK binaries, data, and logs (e.g., 50GB+ as a starting point, highly dependent on data volume).
*   **Connectivity:**
    *   Internet access for downloading Elastic Stack packages (if not in air-gapped mode).
    *   Ensure the following ports are available and accessible on the ELK server:
        *   `9200`: Elasticsearch HTTP
        *   `5601`: Kibana Web UI
        *   `5044`: Logstash Beats input (for Elastic Agent)
        *   `8220`: Fleet Server
*   **LVM (Optional):** If you intend to use the LVM extension feature, the system should have LVM configured with free extents in the volume group containing the root logical volume.

## Scripts Breakdown

The repository contains the following key scripts located in the `ELK-Bash/scripts/` directory:

1.  **`orchestrate.sh` (Main Script)**
    *   **Purpose:** The primary script for a full ELK deployment. It provides a structured, sequential execution of other modular scripts.
    *   **Functionality:**
        *   Calls `foundation.sh` to gather all necessary configuration details (IPs, credentials, Elastic version, deployment type) and perform system cleanup.
        *   Calls `service_install_setup.sh` to install Elasticsearch, Logstash, and Kibana, configure SSL, reset passwords, and create a superuser.
        *   Calls `agent_install_fleet_setup.sh` to download and install Elastic Agent, configure it as a Fleet Server, create default Fleet policies, set up a secure Logstash output for Fleet, and enable ELK services for boot.
        *   If setting up for a cluster, the process generates enrollment tokens for new Elasticsearch nodes.

2.  **`deploy_elasticsearch_node.sh`**
    *   **Purpose:** Specifically used to add a new Elasticsearch node to an existing cluster.
    *   **Functionality:**
        *   Prompts for the new node's details and information about the existing cluster (initial node's IP, credentials, enrollment token generated by the `orchestrate.sh` flow).
        *   Cleans up any local pre-existing Elasticsearch installations.
        *   Installs Elasticsearch.
        *   Uses the provided enrollment token to join the new node to the cluster.
        *   Starts and enables the Elasticsearch service on the new node.

3.  **`foundation.sh`**
    *   **Role:** Gathers initial setup parameters and prepares the system. Sourced by `orchestrate.sh`.
    *   **Functionality:**
        *   Collects user input for deployment type, IP addresses, Elastic Stack version, credentials, and airgapped status.
        *   Handles cleanup of previous ELK installations if indicated.
        *   Optionally attempts to extend the root LVM logical volume on Ubuntu systems.
        *   Exports collected information as environment variables for other scripts.

4.  **`service_install_setup.sh`**
    *   **Role:** Installs and configures the core ELK services. Sourced by `orchestrate.sh`.
    *   **Functionality:**
        *   Installs Elasticsearch, Kibana, and Logstash based on parameters from `foundation.sh`.
        *   Applies configuration templates for each service.
        *   Generates and deploys SSL certificates.
        *   Manages service users and passwords.
        *   Starts the services and creates necessary API keys/tokens for inter-component communication.

5.  **`agent_install_fleet_setup.sh`**
    *   **Role:** Sets up Elastic Agent, Fleet Server, and finalizes the deployment. Sourced by `orchestrate.sh`.
    *   **Functionality:**
        *   Downloads and installs the Elastic Agent.
        *   Configures the agent as a Fleet Server.
        *   Creates default Fleet policies.
        *   Configures Fleet to send data through the Logstash output.
        *   Enables all ELK services for automatic startup.
        *   Generates enrollment tokens if it's the first node of a cluster (this happens as part of the `orchestrate.sh` flow).

6.  **`functions.sh`**
    *   **Role:** A library of utility functions used across other scripts. Not run directly.
    *   **Functionality:** Provides common helpers for input validation, template processing, status spinners, service checks, and output formatting.

## Usage Instructions

### 1. Initial ELK Stack Deployment (Single Node or First Cluster Node)

This is the most common scenario.

*   **Clone the repository:**
    ```bash
    git clone <repository_url>
    cd ELK-Bash/scripts/
    ```
*   **Run the deployment script:**
    Use `orchestrate.sh` for a guided, interactive setup:
    ```bash
    sudo bash orchestrate.sh
    ```
*   **Follow the prompts:** The script (via `foundation.sh`) will ask for:
    *   Whether this is a new node or joining an existing cluster.
    *   Confirmation of previous installations (for cleanup).
    *   Deployment type (single node or cluster).
    *   The IP address this ELK node will use.
    *   Whether the environment is air-gapped (for package downloads).
    *   The Elastic Stack version you wish to install (e.g., `8.18.2`).
    *   A node name for Elasticsearch.
    *   A username and password for the ELK superuser account.
    *   If setting up a cluster, it will ask for the number of *additional* Elasticsearch nodes you plan to add.
*   **Enrollment Tokens (for Cluster Setup):** If you indicated this is the first node of a cluster, the `orchestrate.sh` process (specifically `agent_install_fleet_setup.sh`) will generate enrollment tokens for subsequent Elasticsearch nodes. These tokens are:
    *   Saved to `enrollment_tokens.txt` in the directory where the script was run.
    *   **Valid for only 20 minutes.**
    *   Needed when running `deploy_elasticsearch_node.sh` on other machines.

### 2. Adding Additional Elasticsearch Nodes to a Cluster

After setting up the first node using `orchestrate.sh` and obtaining enrollment tokens:

*   **On each additional Elasticsearch node:**
    *   Clone the repository as above.
    *   Run the `deploy_elasticsearch_node.sh` script:
        ```bash
        sudo bash deploy_elasticsearch_node.sh
        ```
    *   **Follow the prompts:** The script will ask for:
        *   Confirmation of previous installations on *this* new node.
        *   The IP address *this new node* will use.
        *   Whether the environment is air-gapped.
        *   The Elastic Stack version (should match your cluster).
        *   A unique node name for *this new node*.
        *   The IP address of the *first* Elasticsearch node you set up.
        *   The superuser username and password created on the first node.
        *   The enrollment token generated from the first node (via the `orchestrate.sh` flow) for this specific new node.

### Post-Installation

*   Access Kibana via `https://<your_kibana_ip>:5601`.
*   Log in with the superuser credentials you provided during setup.
*   Begin configuring integrations, dashboards, and exploring your data in Fleet and Kibana.

## Configuration Templates

The scripts use template files located in `ELK-Bash/scripts/elk_templates/` to configure services:

*   `elasticsearch.yml.tpl`: For Elasticsearch settings.
*   `kibana.yml.tpl`: For Kibana settings.
*   `logstash.conf.tpl`: For Logstash pipeline (input/output).
*   `logstash.yml.tpl`: For Logstash service settings.

These templates are populated with values derived from user input during the script execution (e.g., `${ELASTIC_HOST}`, `${NODE_NAME}`).

## Important Notes

*   **Security:** The scripts set up basic SSL/TLS. Review and enhance security configurations according to your organization's policies, especially for production environments. This includes managing certificates, user roles, and network access.
*   **Resource Management:** Monitor system resources (CPU, RAM, disk) after deployment, especially under load, and adjust configurations or scale your deployment as needed.
*   **Idempotency:** The scripts include cleanup steps for previous installations, aiming for a degree of idempotency if run multiple times. However, always back up critical data before re-running on an existing system.
*   **Log Files:** Check the service log files for troubleshooting:
    *   Elasticsearch: `/var/log/elasticsearch/`
    *   Kibana: `/var/log/kibana/kibana.log` (logging to file is enabled by the scripts)
    *   Logstash: `/var/log/logstash/`
    *   Elastic Agent: `/opt/Elastic/Agent/data/elastic-agent-*/logs/elastic-agent-*.ndjson`

## License

This project is released under the MIT License. See the LICENSE file for details.
